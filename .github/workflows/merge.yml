name: PR Comment Merge

on:
  issue_comment:
    types: [created]

jobs:
  merge_if_all_green:
    name: Verify Statuses and Merge
    if: |
      github.event.issue.pull_request && 
      contains(github.event.comment.body, ':mergeBranch')

    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
      statuses: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Commenter Permission
        id: check_perms
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ci = require('.github/scripts/merge.js');
            const functions = await ci({ github, context, core });
            try {
              await functions.checkPermissions();
              core.setOutput('permissions_ok', 'true');
            } catch (error) {
              core.setFailed(error.message);
            }

      - name: Wait for Required Status Checks
        id: wait_checks
        if: steps.check_perms.outputs.permissions_ok == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ci = require('.github/scripts/merge.js');
            const functions = await ci({ github, context, core });

            // Note: Passing empty SHA, let the script fetch it
            // This is simpler than trying to extract SHA in YAML
            const requiredChecks = [
              'build-and-test',
              'super-lint'
            ];

            console.log(`Starting merge process for PR #${context.payload.issue.number}`);
            console.log(`Required checks: ${requiredChecks.join(', ')}`);

            try {
              // Pass empty SHA - script will fetch it
              const result = await functions.waitForStatus(requiredChecks, '');
              core.setOutput('checks_result', result);
            } catch (error) {
              core.setFailed(error.message);
            }

      - name: Auto-Merge Pull Request
        id: auto_merge
        if: steps.wait_checks.outputs.checks_result == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ci = require('.github/scripts/merge.js');
            const functions = await ci({ github, context, core });
            const prNumber = context.payload.issue.number;

            try {
              await functions.autoMerge(prNumber);
              core.setOutput('merge_result', 'success');
            } catch (error) {
              core.setFailed(error.message);
            }
