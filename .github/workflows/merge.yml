name: PR Comment Merge

on:
  issue_comment:
    types: [created]

jobs:
  merge_if_all_green:
    name: Verify Statuses and Merge
    if: |
      github.event.issue.pull_request && 
      contains(github.event.comment.body, ':mergeBranch')

    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Debug - Print Context
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Commenter: ${{ github.event.comment.user.login }}"
          echo "Comment: ${{ github.event.comment.body }}"
          echo "PR Number: ${{ github.event.issue.number }}"
          echo "PR URL: ${{ github.event.issue.pull_request.url }}"
          echo "Full event payload:"
          echo '${{ toJSON(github.event) }}' | jq .

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Commenter Permission
        id: check_perms
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ci = require('.github/scripts/merge.js');
            const functions = await ci({ github, context, core });
            try {
              await functions.checkPermissions();
              core.setOutput('permissions_ok', 'true');
            } catch (error) {
              core.setFailed(error.message);
            }

      - name: Wait for Required Status Checks
        id: wait_checks
        if: steps.check_perms.outputs.permissions_ok == 'true'
        uses: actions/github-script@v7
        env:
          PR_SHA: ${{ github.event.issue.pull_request.head.sha }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ci = require('.github/scripts/merge.js');
            const functions = await ci({ github, context, core });
            const requiredChecks = [
              'RevloDB API Integration Tests / build-and-test',
              'Super-Linter / super-lint'
            ];
            const sha = process.env.PR_SHA;

            try {
              const result = await functions.waitForStatus(requiredChecks, sha);
              core.setOutput('checks_result', result);
            } catch (error) {
              core.setFailed(error.message);
            }

      - name: Auto-Merge Pull Request
        id: auto_merge
        if: steps.wait_checks.outputs.checks_result == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const ci = require('.github/scripts/merge.js');
            const functions = await ci({ github, context, core });
            const prNumber = context.payload.issue.number;

            try {
              await functions.autoMerge(prNumber);
              core.setOutput('merge_result', 'success');
            } catch (error) {
              core.setFailed(error.message);
            }
